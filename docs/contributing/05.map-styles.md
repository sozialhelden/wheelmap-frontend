# Map styles

## Getting started

In order to work with Mapbox Studio, you need to configure a valid `MAPBOX_DEVELOPMENT_ACCESS_TOKEN` in the `.env` file. It needs all secret scopes for "MAP", "UPLOADS",  and "STYLES". Also make sure `NEXT_PUBLIC_MAPBOX_ACCOUNT_ID` is set correctly.

## Workflow

The Mapbox map styles are part of this repository as JSON files in the `~/src/modules/map/styles/` folder. You can edit them by hand or use Mapbox Studio, which makes it way easier to do so.

In order to improve the Mapbox Studio workflow, you can and should use the following npm scripts:

```bash
# Start editing map styles in Mapbox Studio
# This will create new temporary styles in Mapbox Studio based 
# on the local styles and icons.
npm run map:style:edit

# Download the map styles from Mapbox Studio
# ⚠️ This overwrites all changes made to the styles locally
# and replaces them with the latest version from Mapbox Studio.
npm run map:style:download

# Upload the local map styles to Mapbox Studio
# ⚠️ This overwrites all changes made to the styles in Mapbox 
# Studio and replaces them with the local ones.
npm run map:style:upload

# Finish editing the map styles in Mapbox Studio
# ⚠️ This will download the latest styles from Mapbox Studio and 
# overwrites the local styles. It also deletes the temporary 
# styles in Mapbox Studio.
npm run map:style:finish
```

Beside the styles, all the icons used in the map styles are also uploaded to Mapbox Studio whenever new temporary styles are created or when you run `map:style:update`. Changes to the icons/images in Mapbox Studio will not be downloaded and reflected locally.

Refer to the [icons documentation](03.icons.md) for more information on how to work with icons.

## Data sources

We have two dedicated services that provide data in the mapbox vector tile (mvt) format to be used as data sources by layers: The `osm-api` and the `accessibility-cloud` service. The `osm-api` provides different data based on OSM data, namely `amenities`, `buildings`, `admin`(-areas), `entrances_or_exists`, etc. While the `accessibility-cloud` service provides only `place-infos`.

Unfortunately, many of the quality of life features in Mapbox Studio only work when using tilesets uploaded to Mapbox Studio itself. Also, we want to configure the map data sources at runtime, so we can configure things like access tokens at runtime too.

In order to achieve all of this, we uploaded a few tilesets to Mapbox Studio that contain a limited amount of real data and are used as data-sources for the layers, e.g. `amenities_with_icons-816g39`. Currently, these contain data from the "Saarbrücken" area only. In the future we will provide a automated process to sync these with the real data and another process to upload additional tilesets from other areas. For now, this has to do.

## Naming conventions for layers and tilesets

By prefixing a layer name with either `osm-`, `ac-` or `osm-ac-` you can mark this layer to get its data from the respective services. If you use `osm-ac-`, the layer will be duplicated, so that one layers exists for each data source. Behind the scenes, the map source will now be changed at runtime. In the `osm` example, the tileset uploaded in Mapbox Studio e.g. `amenities_with_icons-816g39`, will be replaced with a proper configured map source that points to the `amenities` endpoint of the `osm-api` service. If the tileset is named `buildings_something_something`, it will use the `buildings` endpoint of the `osm-api` service and so on. When using the `ac` prefix, the new map source will always point to the `place-infos` endpoint of the `accessibility-cloud` service, no matter the tileset name.
