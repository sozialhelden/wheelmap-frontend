# Map styles

## Getting started

In order to work with Mapbox Studio, you need to configure a valid `MAPBOX_DEVELOPMENT_ACCESS_TOKEN` in the `.env` file. It needs all secret scopes for "MAP", "UPLOADS",  and "STYLES". Also make sure `NEXT_PUBLIC_MAPBOX_ACCOUNT_ID` is set correctly.

## Workflow

The Mapbox map styles are part of this repository as JSON files in the `~/src/modules/map/styles/` folder. You can edit them by hand or use Mapbox Studio, which makes it way easier to do so.

In order to improve the Mapbox Studio workflow, you can and should use the following npm scripts:

```bash
# Start editing map styles in Mapbox Studio
# This will create new temporary styles in Mapbox Studio based 
# on the local styles and icons.
npm run map:style:edit

# Download the map styles from Mapbox Studio
# ⚠️ This overwrites all changes made to the styles locally
# and replaces them with the latest version from Mapbox Studio.
npm run map:style:download

# Upload the local map styles to Mapbox Studio
# ⚠️ This overwrites all changes made to the styles in Mapbox 
# Studio and replaces them with the local ones.
npm run map:style:upload

# Finish editing the map styles in Mapbox Studio
# ⚠️ This will download the latest styles from Mapbox Studio and 
# overwrites the local styles. It also deletes the temporary 
# styles in Mapbox Studio.
npm run map:style:finish
```

Beside the styles, all the icons used in the map styles are also uploaded to Mapbox Studio whenever new temporary styles are created or when you run `map:style:update`. Changes to the icons/images in Mapbox Studio will not be downloaded and reflected locally.

Refer to the [icons documentation](03.icons.md) for more information on how to work with icons.

## Data sources

We have two dedicated services that provide data in the mapbox vector tile (mvt) format to be used as data sources by layers: The `osm-api` and the `accessibility-cloud` service. The `osm-api` provides different data based on OSM data, namely `amenities`, `buildings`, `admin`(-areas), `entrances_or_exists`, etc. While the `accessibility-cloud` service provides only `place-infos`.

Unfortunately, many of the quality of life features in Mapbox Studio only work when using tilesets uploaded to Mapbox Studio itself. Also, we want to configure the map data sources at runtime, so we can configure things like access tokens at runtime too.

In order to achieve all of this, we uploaded a few tilesets to Mapbox Studio that contain a limited amount of real data and are used as data-sources for the layers, e.g. `amenities_with_icons-816g39`. Currently, these contain data from the "Saarbrücken" area only. In the future we will provide a automated process to sync these with the real data and another process to upload additional tilesets from other areas. For now, this has to do.

## Naming conventions for layers and tilesets

### Data source prefix

By prefixing a layer name with either `osm-{collection}-` or `ac-` you can mark this layer to get its data from the respective source. When using multiple prefixes like `osm-{collection}-ac-` the layer will be duplicated, so that one layer exists for each data source. E.g. if your layer is called `osm-amenities-ac-markers` it will result in a `osm-amenities-markers` layer that gets its data from the `osm-api` service and an `ac-markers` layer that gets its data from the `accessibility-cloud` service.

Here's a list of all available prefixes:

| prefix                      | data source                                      |
|-----------------------------|--------------------------------------------------|
| `ac-`                       | `accessibility-cloud` ("place-infos" collection) |
| `osm-admin-`                | `osm-api` ("admin" collection)                   | 
| `osm-amenities-`            | `osm-api` ("amenities" collection)               | 
| `osm-buildings-`            | `osm-api` ("buildings" collection)               | 
| `osm-conveying-`            | `osm-api` ("conveying" collection)               | 
| `osm-elevators-`            | `osm-api` ("elevators" collection)               | 
| `osm-entrances_or_exits-`   | `osm-api` ("entrances_or_exits" collection)      | 
| `osm-master_route_members-` | `osm-api` ("master_route_members" collection)    | 
| `osm-master_routes-`        | `osm-api` ("master_routes" collection)           | 
| `osm-pedestrian_highways-`  | `osm-api` ("pedestrian_highways" collection)     | 
| `osm-places-`               | `osm-api` ("places" collection)                  | 
| `osm-platforms-`            | `osm-api` ("platforms" collection)               | 
| `osm-ramps-`                | `osm-api` ("ramps" collection)                   | 
| `osm-route_members-`        | `osm-api` ("route_members" collection)           | 
| `osm-routes-`               | `osm-api` ("routes" collection)                  | 
| `osm-stations-`             | `osm-api` ("stations" collection)                | 
| `osm-stop_area_members-`    | `osm-api` ("stop_area_members" collection)       | 
| `osm-stop_areas-`           | `osm-api` ("stop_areas" collection)              | 
| `osm-stop_positions-`       | `osm-api` ("stop_positions" collection)          | 
| `osm-toilets-`              | `osm-api` ("toilets" collection)                 | 

### Highlight prefix

To style a feature when it is highlighted, you can create layers with the `highlight-` prefix and turn the visibility off by default. When a feature should be highlighted on the map, it will be rendered using those highlight layers. This prefix stacks with the data source prefix, e.g. `osm-amenities-ac-highlight-markers`.

### List view prefix

The frontend features a separate view that displays a list of all features currently shown on the map. In order to include the features of a layer in the list-view, you can use the `list-` prefix. Note: You cannot use `list-` and `highlight-` at the same time. The list prefix stacks with data source prefixes, e.g. `osm-amenities-ac-list-markers`.
